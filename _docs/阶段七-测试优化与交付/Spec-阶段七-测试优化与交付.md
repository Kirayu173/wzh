# Spec: `S7-TEST-DELIVERY` 测试优化与交付

## 0. 结论摘要（≤8行）

- 本卡交付的最小闭环：完成核心流程测试（订购链路/溯源链路/管理端关键操作）→ 修复高优先级缺陷 → 形成性能与兼容性基线 → 输出交付物清单与测试报告。
- 不做的事（Out-of-scope）：新增业务功能、大规模重构、第三方支付/物流真实对接。
- 关键待决策点（最多3条）：
  - 自动化测试层级：推荐以 IT/UT 为主、UI/E2E 只覆盖关键链路；若引入 Espresso/UIAutomator【待查证】会增加构建配置与维护成本，但提升回归效率。
  - 性能基线口径：推荐以“首页/商品详情/订单列表”加载与接口 P95 作为基线；选择不同设备与网络环境会影响验收阈值与结论。
  - 交付包形式：推荐输出 Release APK + 可执行 JAR；若仅提供 Debug 包将降低可演示性并影响验收演示稳定性。

## 1. Scope

### 1.1 Must

- 功能测试覆盖核心闭环（订购链路与溯源链路）及管理端关键操作，输出可追溯测试报告。
- 修复已发现的阻断/高优先级缺陷并完成回归。
- 进行基础性能与兼容性测试，形成基线与优化记录。
- 代码审查与小范围重构（仅限发现的重复/低质量片段）。
- 文档与交付物准备（APK/JAR/脚本/说明/测试报告）。
- 失败/降级（fallback）：若优化导致不稳定，降级为“关闭优化开关/回退到稳定实现/降低非核心性能目标”，保证核心链路可用。
- 回滚：如发布后出现阻断问题，回滚到上一个稳定 APK/JAR 与对应数据库脚本版本（无新表变更时仅回滚应用）。

### 1.2 Should（推荐）

- 复用既有测试框架与脚手架：后端 JUnit 测试、Android Lint/已有手测流程。
- 关键接口增加 IT 覆盖（登录、下单、支付模拟、溯源查询、管理端发货）。
- 关键页面加载时间与接口响应时间进行 P95 统计。

### 1.3 Could（可选增强）

- 增加基础 UI/E2E 自动化（仅覆盖核心链路）。
- 增加内存泄漏与网络请求聚合分析（如 Android Profiler【待查证】、JProfiler【待查证】）。
- 提供演示视频脚本与演示数据集。

### 1.4 Out-of-scope（明确不做）

- 新业务模块开发。
- 大规模架构迁移或数据库结构大改。
- 生产级监控平台接入。

## 2. 用户故事 & 验收标准（AC）

- AC-001: Given 已有功能清单与核心流程 When 按测试用例执行订购链路与溯源链路 Then 所有 P0 用例通过并记录结果（含缺陷列表/复测记录）。
- AC-002: Given 管理端关键操作（商品/订单/溯源） When 执行测试用例 Then 所有 P0 用例通过且权限校验有效（非 admin 不可操作）。
- AC-003: Given 已记录的阻断/高优先级缺陷 When 完成修复并回归 Then 缺陷关闭且相关回归用例通过。
- AC-004: Given 关键页面与接口 When 进行性能测试 Then 页面加载时间 <3s、接口响应 <1s、内存占用 <200MB（以测试报告记录为准）。
- AC-005: Given 不同 Android 版本与设备尺寸 When 执行兼容性测试 Then 核心流程无崩溃且扫码/支付模拟/下单流程可用。
- AC-006: Given 交付清单 When 打包与整理 Then Release APK、可执行 JAR、数据库脚本、接口/测试/部署说明齐备。

## 3. 数据与契约（按需）

### 3.1 数据模型（本地/后端）

- 无新增数据模型；沿用既有用户/商品/订单/溯源等表结构（参考设计方案与现有实体）。

### 3.2 API 契约（如需要）

- 不新增接口；如需调整接口返回字段以支持测试工具或日志字段，需在变更记录中说明（字段不确定处标注【待查证】）。

### 3.3 状态机（UI/业务）

- 关键页面维持 Loading/Content/Empty/Error 状态，修复异常时回到可操作状态（避免白屏或死状态）。

## 4. 复用建议（一定要仔细阅读复用清单以及各阶段可复用清单目录下的各份文件后进行推荐）

- 可参考的 repo/模块/思路：
  - `测试指导.md`：现有手测流程、环境与常用 curl 模板，可直接复用为回归基线。
  - `items/shop-mall-android`：MVP 基类与工具库减少重构风险；如对性能优化涉及 UI 组件，优先复用成熟实现。
  - `items/suyuan-uniapp`：功能流程与页面结构参考，可用于核对测试用例覆盖面。
  - `items/zxing-android-embedded`：扫码性能与兼容性参考（依赖配置与 SDK 版本需确认）。
- 若计划复制代码：需要你后续确认 license/notice（此处只提示，不下结论）。

## 5. 测试计划（自动化）

- UT: 覆盖 AC-003（后端服务层/状态流转/校验逻辑）。
- IT: 覆盖 AC-001/AC-002/AC-003/AC-006（关键接口回归与权限校验）。
- UI/E2E: 覆盖 AC-001/AC-005（订购链路与扫码溯源关键链路）。

## 6. 可观测性（未上线也适用）

- 必打日志（字段、脱敏建议）
  - 后端：requestId、userId/adminId（脱敏）、endpoint、耗时、错误码。
  - Android：关键页面加载耗时、异常堆栈摘要、网络请求失败原因（不记录敏感信息）。
- 指标建议（延迟/错误/流量/饱和度，按需）
  - 接口 P95/P99、关键页面加载耗时、崩溃率、扫码失败率。
- 追踪建议（可选）
  - requestId 在前后端日志链路贯通，方便定位回归问题。

## 7. 实施任务拆分（给 Codex 的 Task List）

- T-001 整理并补齐核心流程测试用例与执行记录（关联 AC-001/AC-002）。
- T-002 执行回归并修复阻断/高优缺陷（关联 AC-003）。
- T-003 性能与兼容性测试并输出报告（关联 AC-004/AC-005）。
- T-004 代码审查与小范围优化（关联 AC-003/AC-004）。
- T-005 交付物打包与文档更新（关联 AC-006）。

## 8. Definition of Done（DoD）

- [ ] 所有 Must 的 AC 通过
- [ ] 自动化测试通过（UT/IT/关键 UI 回归）
- [ ] 最小可观测性到位（关键日志与错误码覆盖）
- [ ] 文档/变更记录更新（测试报告与交付清单）
