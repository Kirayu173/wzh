# 阶段四评审报告（订单与支付功能）

## 1. 评审范围
- Android 客户端：地址管理、订单确认/支付、订单列表与详情
- 后端服务：地址与订单接口、服务层、状态机与库存逻辑
- 阶段四文档（Spec/ADR/Code/Test/Review）

## 2. 评审方法
- 静态代码走查
- 自动化测试结果复核（后端 `mvn test`、Android Lint）
- 关键流程与状态机一致性检查

## 3. 评审发现
- 代码质量：后端控制器/服务/仓库分层清晰，日志字段完整；Android 模块划分明确，MVP 结构复用良好。
- 架构设计：地址快照写入订单、模拟支付与订单状态枚举均与 ADR 一致，阶段四闭环完整。
- 性能：订单列表一次性读取明细并做聚合，避免 N+1 查询；大数据量场景可考虑分批加载与分页优化。
- 安全性：JWT 密钥仍为占位值；Android 仍启用 `usesCleartextTraffic`，需确认仅限开发环境。
- 可维护性：订单状态/文案统一常量化；Android 使用硬编码颜色切换，后续可统一为 selector。
- 文档完整性：阶段四 Code/Test/Review 文档已补齐，结构与前一阶段一致。

## 4. 改进建议
- 订单确认收货建议严格绑定 `SHIPPED` 状态，避免状态漂移（已在本阶段修复）。
- 为生产环境补充 `request_id` 唯一索引的数据库迁移，确保幂等控制在并发场景稳定生效。
- 将 JWT 密钥与数据库配置移出明文配置文件，避免生产环境安全隐患。
- Android Tab 状态切换建议使用 `StateListDrawable` 或 `ColorStateList`，减少手动颜色切换。

## 5. 风险评估
- 低风险：若生产库未同步 `request_id` 索引，极端并发下可能出现重复下单。
- 中风险：JWT 密钥占位值未替换，生产环境存在安全隐患。
- 低风险：Android 仍允许明文 HTTP，仅适用于开发环境。
- 低风险：订单列表与详情无分页扩展时，大数据量场景可能带来性能压力。
